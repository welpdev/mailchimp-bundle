<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Webhook - MailChimp Bundle</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Webhook";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> MailChimp Bundle</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../setup/">Setup</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../configuration/">Configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../subscriber-provider/">Subscriber Provider</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../usage/">Usage</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Webhook</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#webhook">Webhook</a></li>
                
                    <li><a class="toctree-l4" href="#configuration">Configuration</a></li>
                
                    <li><a class="toctree-l4" href="#register-the-webhook-manually">Register the webhook manually</a></li>
                
                    <li><a class="toctree-l4" href="#command-to-automatically-register-webhook-to-lists">Command to automatically register webhook to lists</a></li>
                
                    <li><a class="toctree-l4" href="#events-to-listen">Events to listen</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../tests/">Tests</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../subscriber-language/">Subscriber Languages</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../mailchimp-doc/">MailChimp Doc</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../CONTRIBUTING/">Contributing</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">MailChimp Bundle</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Webhook</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/welpdev/mailchimp-bundle" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="webhook">Webhook</h1>
<ul>
<li><a href="https://apidocs.mailchimp.com/webhooks/">Documentation</a></li>
<li><a href="http://kb.mailchimp.com/integrations/api-integrations/how-to-set-up-webhooks">How to set up webhooks</a></li>
<li><a href="http://developer.mailchimp.com/documentation/mailchimp/reference/lists/webhooks/">Webhooks API V3</a></li>
</ul>
<p>Webhooks will be triggered when an event occured in MailChimp, and it will call our webhook url and fired Webhook Events in our Symfony App. We will listen to these events in order to add our logic/workflow.</p>
<h2 id="configuration">Configuration</h2>
<p>You need to add the webhook routing to your app routing:</p>
<p><code>app/routing.yml</code></p>
<pre><code>myapp_mailchimp_webhook:
    resource: "@WelpMailchimpBundle/Resources/config/routing.yml"
    prefix:   /mailchimp
</code></pre>
<p>Note: you can change the prefix as you like.</p>
<p>This will generate an url to the webhook like this: <a href="http://domain.com/mailchimp/webhook/endpoint">http://domain.com/mailchimp/webhook/endpoint</a></p>
<p>Also, MailChimp recommand to protect webhook url with a token parameter. So you need to add the secret token to your list in your config.yml</p>
<p><code>config.yml</code></p>
<pre><code>welp_mailchimp:
    api_key: 3419ca97412af7c2893b89894275b415-us14
    lists:
        ba039c6198:
            webhook_secret: thisisTheSecretPass
            ...
</code></pre>
<p>Note: To access properly to the webhook function you will have to use the url with the secret parameter: <a href="http://domain.com/mailchimp/webhook/endpoint?hooksecret=thisisTheSecretPass">http://domain.com/mailchimp/webhook/endpoint?hooksecret=thisisTheSecretPass</a></p>
<h2 id="register-the-webhook-manually">Register the webhook manually</h2>
<p>See <a href="http://kb.mailchimp.com/integrations/api-integrations/how-to-set-up-webhooks">How to set up webhooks</a>.</p>
<p>And the webhook url you have to register is: <a href="http://domain.com/mailchimp/webhook/endpoint?hooksecret=thisisTheSecretPass">http://domain.com/mailchimp/webhook/endpoint?hooksecret=thisisTheSecretPass</a></p>
<h2 id="command-to-automatically-register-webhook-to-lists">Command to automatically register webhook to lists</h2>
<p>There is a command to automatically register webhook to lists</p>
<p>Before using it, you have to add the webhook_url into lists in <code>config.yml</code></p>
<p><code>config.yml</code></p>
<pre><code>welp_mailchimp:
    api_key: 3419ca97412af7c2893b89894275b415-us14
    lists:
        ba039c6198:
            webhook_secret: thisisTheSecretPass
            webhook_url: http://domain.com/mailchimp/webhook/endpoint
</code></pre>
<p>Next in your terminal use this command <code>php app/console welp:mailchimp:webhook</code>. You can verify in your MailChimp List that the webhook has been added.</p>
<h2 id="events-to-listen">Events to listen</h2>
<p>In order to integrate MailChimp into your app workflow, you can listen to different Event.</p>
<p>Event you can listen:</p>
<pre><code>WebhookEvent::EVENT_SUBSCRIBE = 'welp.mailchimp.webhook.subscribe';
WebhookEvent::EVENT_UNSUBSCRIBE = 'welp.mailchimp.webhook.unsubscribe';
WebhookEvent::EVENT_PROFILE = 'welp.mailchimp.webhook.profile';
WebhookEvent::EVENT_CLEANED = 'welp.mailchimp.webhook.cleaned';
WebhookEvent::EVENT_UPEMAIL = 'welp.mailchimp.webhook.upemail';
WebhookEvent::EVENT_CAMPAIGN = 'welp.mailchimp.webhook.campaign';
</code></pre>
<p>Example:</p>
<h3 id="1-create-listener">1- Create listener</h3>
<pre><code class="php">    &lt;?php

    namespace AppBundle\Listener;

    use Symfony\Component\EventDispatcher\EventSubscriberInterface;

    use Welp\MailchimpBundle\Event\WebhookEvent;



    class MailchimpEventListener implements EventSubscriberInterface
    {

        protected $container;


        public function __construct($container)
        {
            $this-&gt;container = $container;
        }

        public static function getSubscribedEvents()
        {
            return [
                WebhookEvent::EVENT_SUBSCRIBE =&gt; 'subscribe',
                WebhookEvent::EVENT_UNSUBSCRIBE =&gt; 'unsubscribe',
                WebhookEvent::EVENT_PROFILE =&gt; 'profile',
                WebhookEvent::EVENT_CLEANED =&gt; 'cleaned',
                WebhookEvent::EVENT_UPEMAIL =&gt; 'upemail',
                WebhookEvent::EVENT_CAMPAIGN =&gt; 'campaign'
            ];
        }

        public function subscribe(WebhookEvent $event){
            $logger = $this-&gt;container-&gt;get('logger');
            $logger-&gt;info('Subscribe Event:', $event-&gt;getData());
        }

        public function unsubscribe(WebhookEvent $event){
            $logger = $this-&gt;container-&gt;get('logger');
            $logger-&gt;info('Unsubscribe Event:', $event-&gt;getData());
        }

        public function profile(WebhookEvent $event){
            $logger = $this-&gt;container-&gt;get('logger');
            $logger-&gt;info('Profile Event:', $event-&gt;getData());
        }

        public function cleaned(WebhookEvent $event){
            $logger = $this-&gt;container-&gt;get('logger');
            $logger-&gt;info('Cleaned Event:', $event-&gt;getData());
        }

        public function upemail(WebhookEvent $event){
            $logger = $this-&gt;container-&gt;get('logger');
            $logger-&gt;info('Upemail Event:', $event-&gt;getData());
        }

        public function campaign(WebhookEvent $event){
            $logger = $this-&gt;container-&gt;get('logger');
            $logger-&gt;info('campaign Event:', $event-&gt;getData());
        }


    }
</code></pre>

<h3 id="2-register-the-listener-into-servicesyml">2- Register the listener into services.yml</h3>
<pre><code>services:
    app.listener.mailchimp.webhook:
        class: AppBundle\Listener\MailchimpEventListener
        tags:
            - { name: kernel.event_subscriber }
        arguments:
            - @service_container
</code></pre>
<h3 id="3-test-with-ngrok-or-other-localhost-tunnel-and-you-will-see-the-result-in-app-log">3- Test with ngrok (or other localhost tunnel) and you will see the result in app log:</h3>
<pre><code>...
[2016-09-05 11:55:48] app.INFO: Unsubscribe Event: {"reason":"manual","id":"5c1b5a7c1e","email":"tztz@gmail.com","email_type":"html","web_id":"3375995","merges":{"EMAIL":"tztz@gmail.com","FNAME":"Tztz","LNAME":"TZST"},"list_id":"ba039c6198"} []
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tests/" class="btn btn-neutral float-right" title="Tests"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../usage/" class="btn btn-neutral" title="Usage"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>MIT</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../usage/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../tests/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
